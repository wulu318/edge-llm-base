name: Build Edge LLM Base All-in-One Installers

on: [push, workflow_dispatch]

jobs:
  build-windows-all-in-one:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install llama-cpp-python[server] pystray pillow pyinstaller uvicorn
      - name: Download Microsoft C++ Redistributable
        # ä¸‹è½½å®˜æ–¹çš„VC++è¿è¡Œåº“å®‰è£…åŒ…
        run: Invoke-WebRequest -Uri https://aka.ms/vs/17/release/vc_redist.x64.exe -OutFile vc_redist.x64.exe
      - name: Build PyInstaller executable
        # åœ¨è¿™é‡Œæˆ‘ä»¬æŠŠ icon.png å’Œæ¨¡å‹æ–‡ä»¶éƒ½ä½œä¸ºæ•°æ®æ–‡ä»¶æ·»åŠ 
        # è¿™æ ·å¯ä»¥ç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®åœ°åŒ…å«åœ¨ç¼–è¯‘ç›®å½•ä¸­
        run: |
          python -c "from edge_llm_base import create_image; create_image('ğŸ¤–').save('icon.png')"
          pyinstaller --onefile --windowed --add-data "icon.png;." edge_llm_base.py
      - name: Download model from Hugging Face
        run: Invoke-WebRequest -Uri https://huggingface.co/a5656789/qwen3-0.6b-q4/resolve/main/qwen3-0.6b-q4.gguf -OutFile dist/qwen3-0.6b-q4.gguf
      - name: Install NSIS
        run: choco install nsis -y
      - name: Create NSIS installer script with C++ Redist
        run: |
          echo '!define PRODUCT_NAME "Edge LLM Base"' > installer.nsi
          echo '!define PRODUCT_VERSION "1.0"' >> installer.nsi
          echo 'OutFile "setup-standalone.exe"' >> installer.nsi
          echo 'InstallDir "$PROGRAMFILES\EdgeLLMBase"' >> installer.nsi
          echo 'RequestExecutionLevel admin' >> installer.nsi
          echo 'Page directory' >> installer.nsi
          echo 'Page instfiles' >> installer.nsi
          echo 'Section "MainSection"' >> installer.nsi
          echo '  SetOutPath "$INSTDIR"' >> installer.nsi
          # å°† VC++ è¿è¡Œåº“æ‰“åŒ…åˆ°å®‰è£…ç¨‹åºä¸­ï¼Œå¹¶åœ¨å®‰è£…æ—¶é™é»˜æ‰§è¡Œ
          echo '  File "vc_redist.x64.exe"' >> installer.nsi
          echo '  ExecWait ''"$INSTDIR\vc_redist.x64.exe" /install /quiet /norestart''' >> installer.nsi
          echo '  Delete "$INSTDIR\vc_redist.x64.exe"' >> installer.nsi
          # å¤åˆ¶ä¸»ç¨‹åºå’Œæ¨¡å‹
          echo '  File "dist\edge_llm_base.exe"' >> installer.nsi
          echo '  File "dist\qwen3-0.6b-q4.gguf"' >> installer.nsi
          echo '  WriteUninstaller "$INSTDIR\uninstall.exe"' >> installer.nsi
          echo '  CreateShortCut "$DESKTOP\Edge LLM Base.lnk" "$INSTDIR\edge_llm_base.exe"' >> installer.nsi
          echo 'SectionEnd' >> installer.nsi
          # ... (å®Œæ•´çš„å¸è½½é€»è¾‘)
      - name: Build NSIS installer
        run: makensis installer.nsi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-standalone
          path: setup-standalone.exe

  build-linux-appimage:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare for ARM64 build if needed
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
      - name: Build AppImage
        uses: aminya/setup-cross-toolchain-action@v2
        with:
          arch: ${{ matrix.arch }}
          skip-qemu: true
      - run: |
          set -ex
          # å®‰è£…ç³»ç»Ÿä¾èµ–
          sudo apt-get update
          sudo apt-get install -y fuse libglib2.0-0
          
          # åˆ›å»ºè™šæ‹ŸPythonç¯å¢ƒ
          python3 -m venv venv
          source venv/bin/activate
          
          # å®‰è£…PythonåŒ…
          pip install --upgrade pip
          pip install llama-cpp-python[server] pystray pillow pyinstaller uvicorn
          
          # åˆ›å»ºå›¾æ ‡å’Œ.desktopæ–‡ä»¶
          python -c "from edge_llm_base import create_image; create_image('ğŸ¤–').save('edge_llm_base.png')"
          echo '[Desktop Entry]' > edge_llm_base.desktop
          echo 'Version=1.0' >> edge_llm_base.desktop
          echo 'Type=Application' >> edge_llm_base.desktop
          echo 'Name=Edge LLM Base' >> edge_llm_base.desktop
          echo 'Exec=edge_llm_base' >> edge_llm_base.desktop
          echo 'Icon=edge_llm_base' >> edge_llm_base.desktop
          echo 'Categories=Utility;' >> edge_llm_base.desktop

          # ç¼–è¯‘Pythonè„šæœ¬
          pyinstaller --noconfirm --onefile --windowed \
            --add-data "edge_llm_base.png:." \
            --add-data "edge_llm_base.desktop:." \
            edge_llm_base.py

          # ä¸‹è½½æ¨¡å‹
          wget https://huggingface.co/a5656789/qwen3-0.6b-q4/resolve/main/qwen3-0.6b-q4.gguf -O dist/qwen3-0.6b-q4.gguf
          
          # ä¸‹è½½linuxdeployå’Œappimagetool
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${{ matrix.arch }}.AppImage -O linuxdeploy.AppImage
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-${{ matrix.arch }}.AppImage -O appimagetool.AppImage
          chmod +x linuxdeploy.AppImage appimagetool.AppImage
          
          # ä½¿ç”¨linuxdeployåˆ›å»ºAppDirï¼Œå®ƒä¼šè‡ªåŠ¨æ‰“åŒ…æ‰€æœ‰ä¾èµ–
          ./linuxdeploy.AppImage --appdir AppDir \
            -e dist/edge_llm_base \
            -d dist/edge_llm_base.desktop \
            -i dist/edge_llm_base.png \
            --output appimage

          # å°†æ¨¡å‹æ–‡ä»¶å¤åˆ¶åˆ°AppDirä¸­ï¼Œç¡®ä¿å®ƒå’Œå¯æ‰§è¡Œæ–‡ä»¶åœ¨ä¸€èµ·
          cp dist/qwen3-0.6b-q4.gguf AppDir/usr/bin/

          # åˆ›å»ºæœ€ç»ˆçš„AppImageæ–‡ä»¶
          ./appimagetool.AppImage AppDir
        env:
          ARCH: ${{ matrix.arch }}
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          path: ./*.AppImage